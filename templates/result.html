{% extends "base.html" %}
{% block title %}Result #{{ submission.id }}{% endblock %}
{% block content %}
<h2>Submission #{{ submission.id }}</h2>
<p><b>Section:</b> {{ submission.report_type.replace('_',' ')|title }}</p>

<img src="/{{ submission.image_path }}" class="img-fluid mb-3" style="max-width:480px">

<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title mb-3">AI Decision Details</h5>

    <div class="row">
      <div class="col-md-6">
        <p class="mb-1"><b>Backend:</b> {{ submission.model_version or 'heuristic' }}</p>
        <p class="mb-1"><b>Relevance:</b> {{ '%.2f'|format(submission.relevance_score or 0) }}</p>
        <p class="mb-1">
          <b>Auth (EXIF):</b> {{ '%.2f'|format(submission.auth_score or 0) }}
          {% if submission.exif_time_ok is not none %}
            <span class="text-muted"> (exif ok={{ submission.exif_time_ok }})</span>
          {% endif %}
        </p>
        <p class="mb-1"><b>GPS:</b>
          {% if submission.lat is not none and submission.lon is not none %}
            {{ '%.5f'|format(submission.lat) }}, {{ '%.5f'|format(submission.lon) }}
          {% else %}
            (no EXIF location)
          {% endif %}
        </p>

        {% if submission.duplicate_of %}
          <p class="mb-1 text-warning">
            <b>Duplicate of submission:</b>
            <a href="{{ url_for('result', sid=submission.duplicate_of) }}">#{{ submission.duplicate_of }}</a>
          </p>
        {% endif %}
      </div>

      <div class="col-md-6">
        <p class="mb-1"><b>Action score:</b> {{ '%.2f'|format(submission.action_score or 0) }}</p>
        <p class="mb-1"><b>Threshold:</b> {{ '%.2f'|format(cutoff or 0.5) }}</p>
        {% if dup_disabled %}
          <p class="mb-1"><b>Duplicate penalty:</b> info-only (no score impact)</p>
        {% else %}
          <p class="mb-1"><b>Duplicate penalty:</b> {{ '%.2f'|format(dup_penalty or 0.40) }}</p>
        {% endif %}
      </div>
    </div>

    <hr class="my-3">
    <p class="mb-1"><b>Final label:</b> {{ submission.ai_label }}</p>
    <p class="mb-0"><b>Status:</b> {{ submission.status }}</p>
  </div>
</div>

{% if current_user.role == 'admin' %}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title mb-3">Admin Actions</h5>

    <!-- Human decision (affects queues) -->
    <form method="post" action="{{ url_for('admin_review_decide', sid=submission.id, decision='approve') }}" class="d-inline">
      <input type="hidden" name="tab" value="pending">
      <input type="hidden" name="type" value="all">
      <input type="hidden" name="dzongkhag" value="all">
      <input type="hidden" name="page" value="1">
      <button class="btn btn-success btn-sm">Approve (human)</button>
    </form>

    <form method="post" action="{{ url_for('admin_review_decide', sid=submission.id, decision='reject') }}" class="d-inline ms-2">
      <input type="hidden" name="tab" value="pending">
      <input type="hidden" name="type" value="all">
      <input type="hidden" name="dzongkhag" value="all">
      <input type="hidden" name="page" value="1">
      <button class="btn btn-outline-danger btn-sm">Reject (human)</button>
    </form>

    <!-- (Optional) keep your existing AI status override -->
    <div class="mt-3">
      <form method="post" action="{{ url_for('admin_mark', sid=submission.id, new_status='AUTO_OK') }}" class="d-inline">
        <button class="btn btn-outline-success btn-sm">Set AI status: AUTO_OK</button>
      </form>
      <form method="post" action="{{ url_for('admin_mark', sid=submission.id, new_status='RECHECK') }}" class="d-inline ms-2">
        <button class="btn btn-outline-danger btn-sm">Set AI status: RECHECK</button>
      </form>
    </div>

    <form method="post" action="{{ url_for('admin_set_category', sid=submission.id) }}" class="d-inline ms-3">
      <div class="input-group input-group-sm" style="width: 320px;">
        <label class="input-group-text">Category</label>
        <select name="report_type" class="form-select">
          <option value="illegal_dumping" {% if submission.report_type == 'illegal_dumping' %}selected{% endif %}>Illegal dumping</option>
          <option value="volunteer_works" {% if submission.report_type == 'volunteer_works' %}selected{% endif %}>Volunteer works</option>
          <option value="dirty_area" {% if submission.report_type == 'dirty_area' %}selected{% endif %}>Dirty area</option>
        </select>
        <button class="btn btn-outline-primary">Save</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<h3 class="mt-4">Messages</h3>
<ul class="list-group mb-3">
  {% for m in submission.messages %}
    <li class="list-group-item">
      <b>{{ m.sender.username }}</b>: {{ m.body }} <small class="text-muted">{{ m.created_at }}</small>
    </li>
  {% else %}
    <li class="list-group-item text-muted">No messages yet.</li>
  {% endfor %}
</ul>

<form method="post" action="{{ url_for('post_message', sid=submission.id) }}" class="d-flex gap-2">
  <input name="body" class="form-control" placeholder="Write a messageâ€¦" required>
  <button class="btn btn-secondary">Send</button>
</form>
{% endblock %}
